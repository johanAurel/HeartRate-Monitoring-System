<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="../static/css/styles.css">
    <title>Heartbeat Rate Monitor</title>
    {% load static %}
    <script src="{% static 'js/websocket.js' %}"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <div id="alert-message" style="display: none; color: red; font-weight: bold;">Heartbeat is too high</div>

    <script>
$(document).ready(function() {
    let heartbeatInterval; // Variable to store the interval ID

    // Connect to MQTT broker
    $('#connect-button').click(function(e) {
        e.preventDefault();

        const deviceId = "{{ device.id }}";
        const mqttBroker = $('#mqtt-broker').val();

        $.ajax({
            url: "{% url 'connect_to_mqtt' %}",
            type: "POST",
            data: {
                device_id: deviceId,
                mqtt_broker: mqttBroker,
                'csrfmiddlewaretoken': '{{ csrf_token }}'
            },
            success: function(response) {
                alert('Connected to MQTT Broker: ' + mqttBroker);
            },
            error: function(xhr, status, error) {
                console.error('Error connecting to MQTT Broker:', error);
            }
        });
    });

    // Toggle device status
$('#toggle-status').click(function(e) {
        e.preventDefault();

        const deviceId = "{{ device.id }}";  // Ensure this variable is correctly set
        const currentStatus = $('#status-display').text().trim();

        $.ajax({
            url: "{% url 'toggle_device_status' %}",  // Ensure this URL is correct
            type: "POST",
            data: {
                device_id: deviceId,
                'csrfmiddlewaretoken': '{{ csrf_token }}'
            },
            success: function(response) {
                // Update the status display and button text
                $('#status-display').text(response.status).css('color', response.status === "ON" ? "green" : "red");
                $('#toggle-status').text(response.status === "ON" ? "Turn OFF" : "Turn ON");
                alert('Device status changed to: ' + response.status);
            },
            error: function(xhr, status, error) {
                console.error('Error changing device status:', error);
            }
        });
    });

    // Simulate heartbeat data
    $('#simulate-heartbeat').click(function(e) {
        e.preventDefault();

        const deviceId = "{{ device.id }}";

        // Disable the simulate button and show the stop button
        $(this).prop('disabled', true);
        $('#stop-heartbeat').show();

        // Start generating heartbeat every second
        heartbeatInterval = setInterval(function() {
            $.ajax({
                url: "{% url 'simulate_heartbeat' %}",
                type: "POST",
                data: {
                    device_id: deviceId,
                    'csrfmiddlewaretoken': '{{ csrf_token }}'
                },
                success: function(response) {
                    updateHeartbeatDisplay(response.heartbeat_rate, response.last_heartbeat, response.alert);
                    showAlertIfHighHeartbeat(response.heartbeat_rate);
                },
                error: function(xhr, status, error) {
                    console.error('Error simulating heartbeat:', error);
                }
            });
        }, 1000); // Call every 1000 milliseconds (1 second)
    });

    // Stop generating heartbeat data
    $('#stop-heartbeat').click(function(e) {
        e.preventDefault();
        
        // Clear the interval to stop heartbeat generation
        clearInterval(heartbeatInterval);
        // Re-enable the simulate button and hide the stop button
        $('#simulate-heartbeat').prop('disabled', false);
        $(this).hide();
        $('#alert-message').hide(); // Hide any alerts when stopped
    });

    function updateHeartbeatDisplay(heartbeatRate, lastHeartbeat, alert) {
        $('#heartbeat-data').text('Heartbeat Rate: ' + heartbeatRate + ' BPM');
        $('#last-heartbeat').text('Last Heartbeat: ' + lastHeartbeat);

        if (alert) {
            $('#heartbeat-data').css('color', 'red').append(' - Alert: High Heartbeat');
        } else {
            $('#heartbeat-data').css('color', 'black');
        }
    }

    function showAlertIfHighHeartbeat(heartbeatRate) {
        const alertMessageDiv = $('#alert-message');
        if (heartbeatRate > 100) {
            alertMessageDiv.text('ALERT: High Heartbeat Rate - ' + heartbeatRate + ' BPM!').show();
        } else {
            alertMessageDiv.hide();
        }
    }
});


</script>
</head>
<body>
    <div style="text-align: center;">
        <button type="button"><a href="{% url 'home' %}">Home</a></button>
    </div>
    
    <h1>Heartbeat Rate Monitor for {{ device.name }}</h1>

   <h2>Device Status</h2>
<p id="device-status">
    <strong>Status:</strong> 
    <span id="status-display" style="color: {% if device.status == 'ON' %}green{% else %}red{% endif %};">
        {{ device.status }}
    </span>        
</p>
<button id="toggle-status">
    {% if device.status == 'ON' %}
        Turn OFF
    {% else %}
        Turn ON
    {% endif %}
</button>



    <hr>
<div id="heartbeat-section" {% if device.status == 'OFF' %}style="display: none;"{% elif device.status == 'ON' %} style ="display: block;"{% endif %}>
    <h2>Simulate Heartbeat</h2>
<button id="simulate-heartbeat">Simulate Heartbeat</button>
<button id="stop-heartbeat" style="display: none;">Stop</button>
<div id="heartbeat-data" style="margin-top: 10px;">
    <!-- Heartbeat data will display here -->
</div>
<p id="last-heartbeat">Last Heartbeat: Not Available</p>
<div id="alert-message" style="display: none; color: red; font-weight: bold;"></div>
</div>


    <hr>

    <h2>Connect to MQTT Broker</h2>
    <label for="mqtt-broker">Enter MQTT Broker Address:</label>
    <input type="text" id="mqtt-broker" required>
    <button id="connect-button">Connect</button>
</body>

</html>
