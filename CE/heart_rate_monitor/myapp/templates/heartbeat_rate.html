<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="../static/css/styles.css" />
    <title>Heartbeat Rate Monitor</title>
    {% load static %}
    <script src="{% static 'js/websocket.js' %}"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <div
      id="alert-message"
      style="display: none; color: red; font-weight: bold;"
    >
      Heartbeat is too high
    </div>

    <script>
      $(document).ready(function () {
        let heartbeatInterval; // Variable to store the interval ID
        let deviceSocket;

        // Connect to MQTT broker

        let mqttClient;

        // Function to connect to AWS IoT endpoint
        function connectToAWSIoT(endpoint) {
          if (!endpoint) {
            alert("Invalid endpoint");
            return;
          }

          const clientId =
            "heartbeatClient-" + Math.floor(Math.random() * 1000000); // Generate a random client ID
          const topic = "heartbeat/data"; // Topic to subscribe to

          // Configure the AWS IoT endpoint
          AWS.config.update({
            region: "us-east-1", // Adjust to your region
            accessKeyId: "{{ aws_access_key_id }}", // Your AWS Access Key
            secretAccessKey: "{{ aws_secret_access_key }}", // Your AWS Secret Access Key
          });

          const iotData = new AWS.IotData({ endpoint: endpoint });

          mqttClient = iotData.getMqttConnection();

          mqttClient.on("message", function (topic, payload) {
            const data = JSON.parse(payload.toString());

            const timestamp = data.timestamp;
            const rate = data.rate;
            const alert =
              rate > 100 ? "ALERT: High Heartbeat Rate!" : null;

            // Display the values
            updateHeartbeatDisplay(rate, timestamp, alert);
          });

          $("#aws-endpoint-form").submit(function (e) {
  e.preventDefault();

  const endpoint = $("#aws-endpoint").val();
  const deviceId = "{{ device.id }}";
  const awsAccessKey = $("#aws-access-key").val();  // Add input for AWS Access Key
  const awsSecretKey = $("#aws-secret-key").val();  // Add input for AWS Secret Key
  
  $.ajax({
    url: "{% url 'listen_to_heartbeat' %}",
    type: "POST",
    data: {
      device_id: deviceId,
      endpoint: endpoint,  // Pass the endpoint from the input field
      aws_access_key: awsAccessKey,  // Pass the AWS Access Key
      aws_secret_key: awsSecretKey  // Pass the AWS Secret Key
    },
    success: function (response) {
      if (response.error) {
        alert("Error: " + response.error);
      } else {
        updateHeartbeatDisplay(response.rate, response.timestamp, response.alert);
      }
    },
    error: function (xhr, status, error) {
      console.error("Error receiving heartbeat:", error);
    }
  });
});

        // Function to update heartbeat display
        function updateHeartbeatDisplay(heartbeatRate, lastHeartbeat, alert) {
          $("#heartbeat-data").text(
            "Heartbeat Rate: " + heartbeatRate + " BPM"
          );
          $("#last-heartbeat").text("Last Heartbeat: " + lastHeartbeat);

          if (alert) {
            $("#alert-message").text(alert).show();
            setTimeout(function () {
              $("#alert-message").fadeOut();
            }, 3000); // Hide alert after 3 seconds
          } else {
            $("#alert-message").hide();
          }
        }

        // Toggle device status

        $("#toggle-status").click(function (e) {
          e.preventDefault();

          const deviceId = "{{ device.id }}"; // Ensure this variable is correctly set

          $.ajax({
            url: "{% url 'toggle_device_status' %}",
            type: "POST",
            data: {
              device_id: deviceId,
              csrfmiddlewaretoken: "{{ csrf_token }}",
            },
            success: function (response) {
              // Update the status display and button text
              $("#status-display")
                .text(response.status)
                .css("color", response.status === "ON" ? "green" : "red");
              $("#toggle-status").text(
                response.status === "ON" ? "Turn OFF" : "Turn ON"
              );
              alert("Device status changed to: " + response.status);
            },
            error: function (xhr, status, error) {
              console.error("Error changing device status:", error);
            },
          });
        });

        // Variable to store the interval ID

         // Simulate heartbeat data
         $("#simulate-heartbeat").click(function (e) {
  e.preventDefault();

  const deviceId = "{{ device.id }}";

  // Disable the simulate button and show the stop button
  $(this).prop("disabled", true);
  $("#stop-heartbeat").show();

  // Start generating heartbeat every second
  heartbeatInterval = setInterval(function () {
    $.ajax({
      url: "{% url 'simulate_heartbeat' %}",
      type: "POST",
      data: {
        device_id: deviceId,
        csrfmiddlewaretoken: "{{ csrf_token }}",
      },
      success: function (response) {
        // Update heartbeat display
        updateHeartbeatDisplay(response.rate, response.timestamp, response.alert);

        // Display recent heartbeats and alerts (updated values from the response)
        displayRecentHeartbeats(response.recent_heartbeats);
        displayRecentAlerts(response.recent_alerts);
      },
      error: function (xhr, status, error) {
        console.error("Error simulating heartbeat:", error);
      },
    });
  }, 1000); // Call every 1000 milliseconds (1 second)
});
        // Stop generating heartbeat data
        $("#stop-heartbeat").click(function (e) {
          e.preventDefault();

          // Clear the interval to stop heartbeat generation
          clearInterval(heartbeatInterval);
          // Re-enable the simulate button and hide the stop button
          $("#simulate-heartbeat").prop("disabled", false);
          $(this).hide();
          $("#alert-message").hide(); // Hide any alerts when stopped
        });

        // Function to update the current heartbeat rate on screen
        function updateHeartbeatDisplay(heartbeatRate, lastHeartbeat, alert) {
  // Update the heartbeat rate and last heartbeat displayed on the page
  $("#heartbeat-data").text("Heartbeat Rate: " + heartbeatRate + " BPM");
  $("#last-heartbeat").text("Last Heartbeat: " + lastHeartbeat);

  // Display alert if heartbeat rate is too high
  if (heartbeatRate > 100) {
    $("#heartbeat-data").css("color", "red");
    $("#alert-message")
      .text("ALERT: High Heartbeat Rate - " + heartbeatRate + " BPM!")
      .show();
    setTimeout(function () {
      $("#alert-message").fadeOut();
    }, 3000); // Hide alert after 3 seconds
  } else if (heartbeatRate < 80) {
    $("#heartbeat-data").css("color", "green");
  } else {
    $("#heartbeat-data").css("color", "blue");
  }

  if (alert) {
    $("#alert-message").text(alert).show();
    setTimeout(function () {
      $("#alert-message").fadeOut();
    }, 3000); // Hide alert after 3 seconds
  } else {
    $("#alert-message").hide();
  }
}

        // Function to display recent heartbeats
        function displayRecentHeartbeats(recentHeartbeats) {
  const heartbeatHistoryDiv = $("#recent-heartbeats");
  heartbeatHistoryDiv.empty(); // Clear previous entries
  recentHeartbeats.forEach(function (hb) {
    const hbElement = 
      <div style="color: ${
        hb.rate > 100
          ? "red"
          : hb.rate < 80
          ? "green"
          : "black"
      };">
        ${hb.rate} BPM at ${hb.timestamp}
      </div>
    ;
    heartbeatHistoryDiv.append(hbElement);
  });
}

function displayRecentAlerts(recentAlerts) {
  const alertHistoryDiv = $("#recent-alerts");
  alertHistoryDiv.empty(); // Clear previous entries
  recentAlerts.forEach(function (alert) {
    const alertElement = <div style="color: red;">${alert.message} at ${alert.timestamp}</div>;
    alertHistoryDiv.append(alertElement);
  });
}

// WebSocket for alert notifications (if needed)
        function connectWebSocket(deviceId) {
          deviceSocket = new WebSocket(
            ws://${window.location.host}/ws/device/${deviceId}/
          );

          deviceSocket.onmessage = function (e) {
            const data = JSON.parse(e.data);
            const alertMessage = data.message;

            if (alertMessage) {
              $("#alert-message").text(alertMessage).show();
              setTimeout(function () {
                $("#alert-message").fadeOut();
              }, 3000); // Hide alert after 3 seconds
            }
          };

          deviceSocket.onclose = function (e) {
            console.error("WebSocket closed unexpectedly");
          };
        }

        // Initialize WebSocket connection when the page loads
        const deviceId = "{{ device.id }}";
        connectWebSocket(deviceId);
      }});
    
      </script>
  </head>
  <body>
    <div style="text-align: center;">
      <button
        type="button"
        style="background-color: rgb(34, 159, 231); color: white;"
      >
        <a href="{% url 'home' %}" style="color: white; text-decoration: none;"
          >Home</a
        >
      </button>
    </div>

    <h1>
      Heartbeat Rate Monitor for
      <span style="color: rgb(34, 159, 231);">{{ device.device_name }}</span>
    </h1>

    <h2>Device Status</h2>
    <p id="device-status">
      <strong>Status:</strong>
      <span
        id="status-display"
        style="color: {% if device.status == 'ON' %}green{% else %}red{% endif %};"
      >
        {{ device.status }}
      </span>
    </p>
    <button
      id="toggle-status"
      style="background-color: rgb(34, 159, 231); color: white;"
    >
      {% if device.status == 'ON' %} Turn OFF {% else %} Turn ON {% endif %}
    </button>

    <hr />
    <div id="heartbeat-section" {% if device.status == 'OFF' %}style="display: none;"{% else %} style ="display: block;"{% endif %}>
      <h2>Simulate Heartbeat</h2>
      <button
        id="simulate-heartbeat"
        style="background-color: rgb(34, 159, 231); color: white;"
      >
        Simulate Heartbeat
      </button>
      <button
        id="stop-heartbeat"
        style="display: none; background-color: rgb(34, 159, 231); color: white;"
      >
        Stop
      </button>

      <!-- Display Heartbeat data -->
      <div id="heartbeat-data" style="font-size: 18px; margin-top: 10px;">Heartbeat Rate: Not Available</div>
      <div id="last-heartbeat" style="font-size: 18px; margin-top: 10px;">Last Heartbeat: Not Available</div>
      <div id="alert-message" style="display: none; color: red; font-weight: bold;"></div>

      <div id="recent-heartbeats" style="margin-top: 20px;">
        <h3>Recent Heartbeats</h3>
        <!-- List of heartbeats -->
      </div>

      <div id="recent-alerts" style="margin-top: 20px;">
        <h3>Recent Alerts</h3>
        <!-- List of alerts -->
      </div>

    <hr />

    <h2>Connect to AWS IoT Endpoint</h2>
    <form id="aws-endpoint-form">
  <label for="aws-endpoint">AWS IoT Endpoint:</label>
  <input type="text" id="aws-endpoint" name="aws-endpoint" placeholder="Enter AWS IoT Endpoint" required>
  
  <label for="aws-access-key">AWS Access Key:</label>
  <input type="text" id="aws-access-key" name="aws-access-key" placeholder="Enter AWS Access Key" required>
  
  <label for="aws-secret-key">AWS Secret Key:</label>
  <input type="text" id="aws-secret-key" name="aws-secret-key" placeholder="Enter AWS Secret Key" required>
  
  <label for="topic">Topic</label>
  <input type="text" id="topic" name="topic" placeholder="Enter topic" required>
  <button type="submit" id="listen-heartbeat">Start Listening</button>
</form>

  </body>
</html>